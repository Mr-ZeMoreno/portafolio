<script>
  import { $, $$, clases, dotClass } from "../js/utils";

  export class Console {
    padre: HTMLElement;
    comandos: { [key: string]: (inputValue: string) => void };

    constructor(padre: HTMLElement) {
      this.padre = padre;
      this.comandos = {
        hola: this.hola.bind(this),
        clear: this.clear.bind(this),
        play: this.play.bind(this),
        pause: this.pause.bind(this),
        help: this.help.bind(this),
      };

      this.setupAudioEvents();
    }

    setupAudioEvents() {
      const $rep = document.querySelector("#audio-rep") as HTMLAudioElement;

      if ($rep) {
        $rep.addEventListener("ended", () => {
          const $thumbnail = document.querySelector(".imagen") as HTMLElement;
          $thumbnail.classList.remove("invert-color");
          const $timer = $thumbnail.querySelector(
            "span.ml-auto"
          ) as HTMLElement;

          if ($timer) {
            $timer.classList.add("hidden");
          }
        });
      }
    }

    appendChild(inputValue: string, clase: string) {
      const $msgLine = document.createElement("div");
      $msgLine.classList.add(clase);
      $msgLine.innerHTML = `<span class="green">></span><p></p>`;

      const $parrafo = $msgLine.querySelector("p");
      if ($parrafo) {
        $parrafo.textContent = inputValue;
      }

      if (this.padre) {
        this.padre.appendChild($msgLine);
      }
    }

    clear() {
      this.padre.innerHTML = "";
    }

    hola() {
      this.appendChild(
        "Hola, Soy Josecarlos, tambiÃ©n conocido como Zemoreno. " +
          "Soy apasionado de la programaciÃ³n ðŸ‘¨ðŸ½â€ðŸ’», el sushi ðŸ£ y la mÃºsica soul ðŸŽ§. " +
          "No dudes en contactarme a mi correo y disfruta de la canciÃ³n de turno, " +
          "la cual voy cambiando semanalmente.",
        "middle-msg"
      );
      this.appendChild(".", "middle-msg");
      this.appendChild(".", "middle-msg");
      this.help();
    }

    help() {
      const comandosList = Object.keys(this.comandos).map((comando) => {
        return `${comando}`;
      });

      const helpMessage =
        comandosList.length > 0
          ? `Comandos disponibles: ${comandosList.join(", ")}`
          : "No hay comandos disponibles.";

      this.appendChild(helpMessage, "middle-msg");
    }

    play() {
      this.appendChild("Reproduciendo", "middle-msg");
      const $thumbnail = document.querySelector(".imagen") as HTMLElement;
      const $timer = $thumbnail.querySelector("span.ml-auto") as HTMLElement;
      const $rep = document.querySelector("#audio-rep") as HTMLAudioElement;

      $thumbnail.classList.add("invert-color");
      $timer.classList.remove("hidden");
      $rep.play();
    }

    pause() {
      this.appendChild("Pausado", "middle-msg");
      const $thumbnail = document.querySelector(".imagen") as HTMLElement;
      const $rep = document.querySelector("#audio-rep") as HTMLAudioElement;

      $thumbnail.classList.remove("invert-color");
      $rep.pause();
    }

    ejecutarComando(inputValue: string) {
      const comando = inputValue.toLowerCase();
      if (this.comandos[comando]) {
        this.appendChild(inputValue, "inline-msg");
        this.comandos[comando](inputValue);
      } else {
        this.appendChild(`Comando no reconocido: ${inputValue}`, "middle-msg");
      }
    }

    removeAllElements(htmlElement: NodeListOf<Element>) {
      if (htmlElement.length >= 0) {
        htmlElement.forEach((elemento) => {
          elemento.remove();
        });
      }
    }

    limpiarInput(htmlElement: HTMLInputElement) {
      htmlElement.value = "";
    }
  }

  document.addEventListener("DOMContentLoaded", () => {
    const $inputElement = $("#input-msg") as HTMLInputElement;

    $(".consola-box")?.addEventListener("click", () => {
      $inputElement.focus();
    });

    $("#input-form")?.addEventListener("submit", function (event) {
      event.preventDefault();

      $inputElement.placeholder = "";

      const $consola = $(dotClass(clases.CONSOLA)) as HTMLElement;
      const consola = new Console($consola);

      if ($inputElement) {
        const inputValue = $inputElement.value;
        consola.limpiarInput($inputElement);

        consola.ejecutarComando(inputValue);

        let $$inlineMsg = $$(dotClass(clases.INLINE), $consola);
        let contador = $$inlineMsg.length + 1;

        if (contador % 8 == 0 && contador > 0) {
          const $alertMsg = $$(dotClass(clases.ALERTA), $consola);
          consola.removeAllElements($alertMsg);
          consola.appendChild("intenta usar el comando 'clear'", clases.ALERTA);
        }
      }
    });
  });
</script>

<div
  class="consola-box h-48 md:h-full max-h-48 md:max-h-none overflow-y-scroll bg-[#000000ac] md:bg-[#00000029]"
>
  <form id="input-form">
    <label>
      <span class="green">></span>
      <input
        id="input-msg"
        type="text"
        name="linea de comandos"
        autocomplete="off"
        placeholder='Intenta con "Hola"'
      />
    </label>
  </form>
  <div class="consola msg"></div>
</div>

<style is:global>
  .inline-msg,
  .middle-msg {
    display: flex;
    flex-direction: row;
    p {
      padding-left: 5px;
    }
  }
  .middle-msg > p {
    margin: 0 auto;
    text-align: center;
    letter-spacing: 0.23em;
    font-size: 13px;
  }
  .green {
    color: #25cc54;
  }
  .middle-msg > .green {
    display: none;
  }
</style>

<style>
  .consola-box,
  #input-form {
    font-family: "Orbitron";
  }

  #input-form {
    label {
      display: flex;
      flex-direction: row;
      input {
        background: transparent;
        border: 0;
        outline: none;
        padding-left: 5px;
        font-size: 12px;
        color: white;
      }
    }
  }
  .consola-box {
    grid-area: consola;
    display: flex;
    flex-direction: column-reverse;
    padding: 10px;
    padding-bottom: 5px;
  }
  .consola {
    font-size: 12px;
  }
</style>
